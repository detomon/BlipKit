/*
 * Copyright (c) 2012-2015 Simon Schoenenberger
 * http://blipkit.audio
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

#include "BKBuffer.h"

extern BKBufferPulse const BKBufferStepPhasesSinc;
extern BKBufferPulse const BKBufferStepPhasesHarm;

// clang-format off

/**
 * Bandlimited step phases
 * Generated with `sinc_phases.c`
 */
BKBufferPulse const BKBufferStepPhasesSinc = { .frames = {
	{     0,      0,      0,      1,     -3,      6,    -10,     16,    -25,     36,    -52,     74,   -105,    155,   -249,    519,  32746,   -488,    230,   -140,     92,    -62,     42,    -28,     18,    -11,      7,     -4,      2,      0,      0,      0, },
	{     0,      0,      0,     -1,      3,     -6,     10,    -16,     25,    -36,     52,    -73,    105,   -154,    246,   -504,  32762,    503,   -234,    141,    -93,     63,    -42,     28,    -18,     11,     -7,      4,     -2,      0,      0,      0, },
	{     0,      0,      2,     -5,     11,    -19,     31,    -49,     74,   -108,    155,   -219,    312,   -456,    724,  -1463,  32672,   1556,   -712,    428,   -280,    189,   -128,     86,    -56,     35,    -21,     12,     -6,      2,      0,      0, },
	{     0,     -1,      4,     -9,     18,    -32,     52,    -82,    123,   -179,    256,   -362,    513,   -749,   1183,  -2353,  32483,   2666,  -1200,    716,   -468,    316,   -214,    143,    -94,     59,    -35,     20,    -10,      4,     -1,      0, },
	{     0,     -1,      5,    -13,     25,    -44,     72,   -113,    170,   -247,    353,   -499,    707,  -1029,   1616,  -3173,  32189,   3829,  -1692,   1005,   -655,    441,   -299,    200,   -131,     82,    -49,     28,    -14,      6,     -2,      0, },
	{     0,     -2,      7,    -16,     32,    -56,     92,   -143,    215,   -313,    446,   -630,    891,  -1293,   2023,  -3919,  31790,   5040,  -2185,   1290,   -839,    564,   -381,    255,   -167,    105,    -63,     36,    -18,      8,     -2,      0, },
	{     0,     -2,      8,    -20,     38,    -67,    110,   -172,    258,   -375,    534,   -753,   1064,  -1541,   2399,  -4590,  31299,   6293,  -2674,   1569,  -1017,    683,   -462,    308,   -201,    127,    -76,     43,    -22,      9,     -3,      0, },
	{     0,     -3,     10,    -23,     44,    -78,    127,   -199,    298,   -433,    617,   -868,   1224,  -1770,   2742,  -5184,  30710,   7583,  -3155,   1840,  -1190,    797,   -538,    359,   -234,    148,    -89,     50,    -26,     11,     -3,      0, },
	{     0,     -3,     11,    -26,     50,    -87,    143,   -223,    335,   -486,    692,   -973,   1371,  -1977,   3051,  -5700,  30022,   8904,  -3622,   2099,  -1353,    906,   -610,    407,   -266,    167,   -101,     57,    -29,     12,     -4,      0, },
	{     0,     -4,     12,    -28,     55,    -96,    158,   -246,    368,   -535,    760,  -1068,   1503,  -2162,   3322,  -6138,  29250,  10249,  -4072,   2345,  -1507,   1007,   -678,    452,   -295,    186,   -112,     63,    -32,     14,     -4,      0, },
	{     0,     -4,     13,    -31,     60,   -104,    171,   -266,    398,   -578,    821,  -1152,   1619,  -2323,   3555,  -6499,  28390,  11613,  -4498,   2573,  -1648,   1099,   -739,    493,   -321,    202,   -121,     68,    -35,     15,     -4,      0, },
	{     0,     -4,     14,    -33,     63,   -111,    182,   -283,    424,   -615,    873,  -1224,   1717,  -2460,   3748,  -6782,  27455,  12989,  -4897,   2782,  -1777,   1183,   -795,    529,   -344,    217,   -130,     73,    -38,     16,     -5,      0, },
	{     0,     -4,     15,    -35,     67,   -117,    191,   -298,    445,   -646,    916,  -1284,   1799,  -2571,   3901,  -6989,  26442,  14369,  -5264,   2969,  -1890,   1256,   -843,    561,   -365,    230,   -138,     78,    -40,     17,     -5,      0, },
	{     0,     -5,     16,    -36,     69,   -122,    199,   -309,    462,   -670,    951,  -1331,   1862,  -2655,   4014,  -7122,  25358,  15747,  -5594,   3133,  -1988,   1318,   -883,    587,   -382,    240,   -144,     81,    -42,     18,     -5,      0, },
	{     0,     -5,     16,    -37,     71,   -125,    204,   -318,    475,   -688,    976,  -1364,   1906,  -2713,   4085,  -7183,  24213,  17116,  -5883,   3269,  -2068,   1369,   -916,    608,   -395,    249,   -149,     84,    -43,     19,     -6,      0, },
	{     0,     -5,     17,    -38,     73,   -127,    208,   -323,    483,   -700,    991,  -1385,   1932,  -2744,   4117,  -7174,  23008,  18468,  -6126,   3378,  -2129,   1407,   -940,    624,   -405,    255,   -153,     86,    -44,     19,     -6,      0, },
	{     0,     -5,     17,    -38,     73,   -128,    210,   -326,    486,   -704,    997,  -1391,   1939,  -2748,   4108,  -7098,  21755,  19797,  -6319,   3457,  -2171,   1431,   -956,    634,   -411,    258,   -155,     87,    -45,     19,     -6,      0, },
	{     0,     -5,     17,    -38,     73,   -128,    209,   -325,    485,   -702,    993,  -1385,   1927,  -2727,   4061,  -6959,  20457,  21095,  -6458,   3504,  -2192,   1443,   -962,    637,   -413,    260,   -156,     88,    -45,     19,     -6,      0, },
	{     0,     -5,     16,    -38,     72,   -127,    207,   -321,    479,   -693,    980,  -1365,   1898,  -2679,   3977,  -6759,  19122,  22356,  -6540,   3518,  -2193,   1440,   -959,    635,   -412,    258,   -155,     87,    -45,     19,     -6,      0, },
	{     0,     -5,     16,    -37,     71,   -124,    202,   -314,    469,   -678,    957,  -1333,   1850,  -2607,   3857,  -6504,  17758,  23572,  -6562,   3498,  -2173,   1424,   -947,    626,   -406,    254,   -152,     86,    -44,     19,     -6,      0, },
	{     0,     -5,     16,    -36,     69,   -120,    196,   -304,    454,   -656,    926,  -1288,   1786,  -2511,   3703,  -6197,  16369,  24737,  -6519,   3443,  -2131,   1394,   -926,    611,   -396,    248,   -149,     84,    -43,     18,     -6,      0, },
	{     0,     -4,     15,    -34,     66,   -115,    188,   -292,    435,   -628,    885,  -1231,   1705,  -2393,   3517,  -5843,  14964,  25844,  -6410,   3353,  -2067,   1349,   -895,    591,   -382,    239,   -143,     81,    -41,     18,     -5,      0, },
	{     0,     -4,     14,    -32,     62,   -109,    178,   -276,    411,   -594,    837,  -1163,   1608,  -2254,   3302,  -5447,  13555,  26888,  -6232,   3228,  -1982,   1291,   -855,    564,   -364,    228,   -137,     77,    -39,     17,     -5,      0, },
	{     0,     -4,     13,    -30,     58,   -102,    166,   -258,    384,   -554,    781,  -1084,   1498,  -2095,   3060,  -5013,  12143,  27862,  -5984,   3068,  -1876,   1219,   -806,    531,   -343,    215,   -128,     72,    -37,     16,     -5,      0, },
	{     0,     -4,     12,    -28,     54,    -94,    153,   -237,    353,   -510,    718,   -996,   1374,  -1919,   2793,  -4546,  10739,  28761,  -5663,   2872,  -1749,   1134,   -749,    493,   -318,    199,   -119,     67,    -34,     15,     -4,      0, },
	{     0,     -3,     11,    -25,     49,    -85,    139,   -215,    320,   -461,    649,   -899,   1239,  -1727,   2506,  -4052,   9344,  29580,  -5269,   2643,  -1602,   1037,   -684,    450,   -290,    181,   -108,     61,    -31,     13,     -4,      0, },
	{     0,     -3,     10,    -22,     43,    -75,    123,   -190,    283,   -408,    573,   -794,   1093,  -1521,   2201,  -3537,   7975,  30313,  -4801,   2381,  -1437,    927,   -611,    401,   -259,    162,    -96,     54,    -27,     12,     -3,      0, },
	{     0,     -2,      8,    -19,     37,    -65,    106,   -164,    243,   -351,    493,   -682,    938,  -1304,   1881,  -3004,   6635,  30958,  -4260,   2087,  -1254,    807,   -531,    348,   -224,    140,    -84,     47,    -24,     10,     -3,      0, },
	{     0,     -2,      7,    -16,     31,    -54,     88,   -136,    202,   -291,    409,   -565,    776,  -1077,   1549,  -2459,   5323,  31510,  -3644,   1763,  -1055,    677,   -445,    292,   -188,    117,    -70,     39,    -20,      8,     -2,      0, },
	{     0,     -1,      5,    -12,     24,    -42,     69,   -107,    159,   -228,    321,   -443,    609,   -843,   1209,  -1908,   4049,  31965,  -2956,   1412,   -840,    538,   -353,    231,   -149,     93,    -55,     31,    -16,      7,     -2,      0, },
	{     0,     -1,      4,     -9,     17,    -30,     49,    -77,    114,   -164,    231,   -318,    437,   -604,    864,  -1356,   2826,  32321,  -2197,   1035,   -613,    392,   -256,    168,   -108,     67,    -40,     22,    -11,      5,     -1,      0, },
	{     0,      0,      2,     -5,     10,    -18,     30,    -46,     69,    -99,    139,   -191,    262,   -362,    517,   -807,   1651,  32577,  -1368,    635,   -374,    239,   -156,    102,    -65,     40,    -24,     13,     -7,      3,      0,      0, },
}};

/**
 * Bandlimited step phases
 * Generated with `harm_phases.c`
 */
BKBufferPulse const BKBufferStepPhasesHarm = { .frames = {
	{     0,      0,     -3,     10,    -25,     52,    -97,    168,   -276,    433,   -660,    991,  -1498,   2369,  -4328,  19208,  19287,  -4328,   2369,  -1498,    991,   -660,    433,   -276,    168,    -97,     52,    -25,     10,     -3,      0,      0, },
	{     0,      0,     -1,      7,    -19,     42,    -83,    148,   -249,    398,   -616,    939,  -1436,   2297,  -4242,  18108,  20352,  -4368,   2416,  -1545,   1034,   -697,    464,   -300,    187,   -110,     61,    -30,     13,     -4,      1,      0, },
	{     0,      0,      0,      3,    -13,     32,    -68,    127,   -219,    359,   -567,    877,  -1361,   2204,  -4113,  16983,  21387,  -4360,   2439,  -1576,   1066,   -727,    490,   -322,    204,   -122,     69,    -36,     16,     -6,      1,      0, },
	{     0,     -1,      1,      0,     -7,     22,    -52,    104,   -188,    317,   -512,    808,  -1273,   2089,  -3945,  15839,  22375,  -4300,   2437,  -1591,   1088,   -750,    511,   -340,    218,   -133,     77,    -41,     19,     -7,      2,      0, },
	{     0,     -1,      3,     -3,      0,     12,    -36,     81,   -155,    272,   -453,    731,  -1173,   1956,  -3741,  14681,  23313,  -4186,   2408,  -1590,   1099,   -766,    528,   -355,    231,   -143,     84,    -45,     22,     -9,      2,      0, },
	{     0,     -2,      4,     -6,      5,      1,    -20,     56,   -120,    225,   -389,    647,  -1063,   1805,  -3504,  13515,  24203,  -4016,   2352,  -1572,   1098,   -773,    539,   -366,    241,   -151,     90,    -49,     24,    -10,      3,      0, },
	{     0,     -2,      6,     -9,     11,     -8,     -3,     31,    -84,    175,   -323,    558,   -944,   1640,  -3240,  12348,  25035,  -3789,   2269,  -1537,   1086,   -773,    544,   -374,    248,   -158,     95,    -53,     26,    -11,      3,      0, },
	{     0,     -2,      7,    -12,     17,    -18,     12,      6,    -48,    124,   -253,    464,   -817,   1460,  -2951,  11185,  25806,  -3503,   2160,  -1486,   1062,   -765,    544,   -378,    254,   -163,     99,    -56,     28,    -12,      3,      0, },
	{     0,     -3,      8,    -15,     23,    -29,     29,    -18,    -12,     73,   -182,    367,   -683,   1270,  -2641,  10032,  26504,  -3157,   2024,  -1417,   1027,   -748,    538,   -378,    256,   -166,    102,    -58,     30,    -13,      4,      0, },
	{     0,     -3,     10,    -18,     28,    -38,     45,    -42,     24,     21,   -109,    267,   -545,   1071,  -2314,   8895,  27135,  -2751,   1861,  -1333,    981,   -724,    527,   -374,    256,   -168,    104,    -60,     31,    -14,      4,      0, },
	{     0,     -4,     11,    -21,     34,    -48,     60,    -66,     60,    -30,    -36,    165,   -403,    865,  -1975,   7780,  27689,  -2283,   1674,  -1232,    924,   -692,    510,   -366,    253,   -168,    106,    -62,     32,    -14,      4,      0, },
	{     0,     -4,     12,    -23,     39,    -56,     75,    -90,     95,    -81,     36,     63,   -259,    655,  -1627,   6691,  28166,  -1756,   1463,  -1117,    856,   -652,    487,   -354,    248,   -166,    106,    -62,     33,    -15,      4,      0, },
	{     0,     -4,     13,    -26,     43,    -65,     89,   -112,    129,   -131,    108,    -38,   -115,    442,  -1274,   5633,  28566,  -1169,   1229,   -987,    779,   -605,    459,   -339,    240,   -163,    104,    -62,     33,    -15,      5,      0, },
	{     0,     -4,     13,    -27,     47,    -72,    102,   -133,    161,   -180,    178,   -138,     27,    230,   -920,   4611,  28881,   -523,    974,   -844,    692,   -551,    427,   -319,    230,   -158,    102,    -62,     33,    -15,      5,      0, },
	{     0,     -5,     14,    -29,     51,    -79,    113,   -152,    192,   -226,    245,   -235,    168,     19,   -569,   3630,  29115,    179,    701,   -690,    596,   -491,    389,   -297,    217,   -151,     99,    -60,     33,    -15,      5,      0, },
	{     0,     -5,     14,    -30,     54,    -85,    124,   -170,    220,   -269,    309,   -329,    305,   -186,   -223,   2694,  29258,    937,    410,   -525,    493,   -425,    348,   -271,    202,   -142,     95,    -58,     32,    -15,      5,      0, },
	{     0,     -5,     15,    -31,     56,    -90,    133,   -186,    246,   -309,    370,   -418,    437,   -386,    113,   1805,  29317,   1749,    106,   -350,    383,   -354,    302,   -242,    184,   -132,     89,    -56,     31,    -15,      5,      0, },
	{     0,     -5,     15,    -32,     58,    -94,    141,   -200,    269,   -346,    426,   -502,    562,   -578,    438,    968,  29290,   2610,   -209,   -169,    268,   -279,    252,   -211,    165,   -121,     83,    -53,     30,    -14,      5,      0, },
	{     0,     -5,     15,    -32,     59,    -97,    148,   -212,    290,   -379,    478,   -580,    680,   -760,    747,    185,  29176,   3518,   -534,     17,    148,   -199,    200,   -177,    144,   -108,     76,    -49,     28,    -14,      4,      0, },
	{     0,     -5,     15,    -32,     60,    -99,    153,   -222,    307,   -408,    524,   -651,    789,   -930,   1039,   -540,  28975,   4470,   -864,    209,     24,   -117,    145,   -141,    121,    -95,     68,    -45,     26,    -13,      4,      0, },
	{     0,     -4,     14,    -32,     60,   -100,    156,   -229,    321,   -433,    564,   -715,    888,  -1088,   1311,  -1207,  28691,   5462,  -1197,    402,   -101,    -32,     88,   -103,     96,    -80,     59,    -40,     24,    -12,      4,      0, },
	{     0,     -4,     14,    -31,     59,   -100,    158,   -234,    332,   -453,    598,   -771,    977,  -1231,   1561,  -1814,  28324,   6488,  -1528,    595,   -228,     53,     29,    -64,     71,    -64,     50,    -35,     22,    -11,      4,      0, },
	{     0,     -4,     13,    -30,     58,    -99,    158,   -237,    339,   -468,    626,   -818,   1054,  -1359,   1786,  -2360,  27877,   7546,  -1855,    787,   -354,    140,    -29,    -24,     45,    -47,     40,    -30,     19,    -10,      3,      0, },
	{     0,     -4,     13,    -29,     56,    -97,    156,   -237,    343,   -478,    646,   -856,   1119,  -1470,   1987,  -2843,  27353,   8629,  -2174,    974,   -479,    226,    -89,     16,     18,    -30,     30,    -24,     16,     -8,      3,      0, },
	{     0,     -3,     12,    -28,     54,    -94,    153,   -234,    343,   -483,    661,   -885,   1172,  -1563,   2160,  -3263,  26748,   9734,  -2481,   1155,   -600,    311,   -148,     57,     -9,    -12,     19,    -18,     13,     -7,      3,      0, },
	{     0,     -3,     11,    -26,     51,    -90,    148,   -229,    339,   -483,    668,   -904,   1212,  -1639,   2306,  -3622,  26082,  10854,  -2773,   1328,   -718,    394,   -207,     98,    -36,      4,      8,    -11,      9,     -6,      2,      0, },
	{     0,     -2,     10,    -23,     47,    -85,    142,   -222,    332,   -478,    668,   -914,   1239,  -1696,   2423,  -3918,  25343,  11983,  -3045,   1491,   -830,    473,   -264,    137,    -63,     22,     -2,     -5,      6,     -4,      2,      0, },
	{     0,     -2,      8,    -21,     43,    -79,    134,   -213,    322,   -469,    661,   -915,   1253,  -1735,   2512,  -4153,  24544,  13118,  -3294,   1642,   -935,    549,   -318,    176,    -90,     40,    -13,      1,      3,     -3,      1,      0, },
	{     0,     -2,      7,    -18,     39,    -73,    125,   -201,    309,   -454,    648,   -906,   1254,  -1755,   2571,  -4329,  23683,  14250,  -3516,   1779,  -1032,    620,   -370,    214,   -116,     57,    -24,      7,      0,     -1,      1,      0, },
	{     0,     -1,      6,    -16,     34,    -66,    115,   -188,    292,   -435,    628,   -887,   1242,  -1756,   2602,  -4447,  22772,  15376,  -3709,   1901,  -1120,    685,   -419,    249,   -141,     74,    -35,     14,     -3,      0,      0,      0, },
	{     0,     -1,      4,    -13,     29,    -58,    103,   -173,    272,   -412,    602,   -860,   1217,  -1739,   2605,  -4509,  21814,  16487,  -3867,   2005,  -1197,    745,   -463,    282,   -165,     90,    -45,     20,     -7,      1,      0,      0, },
	{     0,      0,      3,    -10,     24,    -49,     91,   -155,    250,   -384,    570,   -825,   1180,  -1705,   2581,  -4518,  20808,  17580,  -3988,   2090,  -1263,    797,   -504,    312,   -187,    106,    -56,     26,    -10,      3,      0,      0, },
}};

// clang-format on

BKBufferPulse const* const BKBufferPulseKernels[] = {
	[BK_PULSE_KERNEL_SINC] = &BKBufferStepPhasesSinc,
	[BK_PULSE_KERNEL_HARM] = &BKBufferStepPhasesHarm,
};

BKInt BKBufferInit(BKBuffer* buf) {
	memset(buf, 0, sizeof(BKBuffer));
	BKBufferClear(buf);

	buf->pulse = &BKBufferStepPhasesHarm;

	return 0;
}

void BKBufferDispose(BKBuffer* buf) {
	BKBufferClear(buf);
}

BKInt BKBufferRead(BKBuffer* buf, BKFrame outFrames[], BKUInt size, BKUInt interlace) {
	BKInt* frames = &buf->frames[0];
	BKInt accum = buf->accum;

	interlace = BKMax(interlace, 1);   // step must be at least 1
	size = BKMin(size, buf->capacity); // can only read available frames

	while (frames < &buf->frames[size]) {
		accum -= (accum >> (BK_INT_SHIFT - BK_HIGH_PASS_SHIFT)); // apply high pass filter
		accum += (*frames++);									 // accumulate

		BKInt amp = accum >> (BK_INT_SHIFT - BK_FRAME_SHIFT - 2); // remove fraction

		// clamp
		if ((BKFrame)amp != amp) {
			amp = (amp >> BK_FRAME_SHIFT) ^ BK_FRAME_MAX;
		}

		// write frame
		(*outFrames) = amp;
		outFrames += interlace;
	}

	BKUInt bufferSize = buf->capacity + BK_STEP_WIDTH + 1;

	// move frames left
	memmove(&buf->frames[0], &buf->frames[size], sizeof(BKInt) * (bufferSize - size));
	// zero right gap
	memset(&buf->frames[bufferSize - size], 0, sizeof(BKInt) * size);
	// reduce remaining capacity
	buf->capacity -= size;

	buf->accum = accum;
	buf->time -= size << BK_FINT20_SHIFT;

	return size;
}

void BKBufferClear(BKBuffer* buf) {
	void const* pulse = buf->pulse;

	memset(buf, 0, sizeof(BKBuffer));
	buf->pulse = pulse;
}
